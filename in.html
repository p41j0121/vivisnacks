<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Vivi Snacks</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

    body {
      font-family: 'Poppins', sans-serif;
      background: #fff0f5;
      margin:0;
      padding:0;
      display:flex;
      justify-content:center;
      align-items:center;
      min-height:100vh;
    }
    .card {
      background: linear-gradient(135deg, #fff0f5, #ffe4e1);
      border-radius:20px;
      box-shadow:0 8px 20px rgba(0,0,0,0.15);
      padding:30px;
      width:100%;
      max-width:520px;
      text-align:center;
      animation: fadeIn 0.5s ease;
    }
    @keyframes fadeIn {
      from { opacity:0; transform:scale(0.9); }
      to { opacity:1; transform:scale(1); }
    }
    h2 {
      font-family: 'Fredoka One', cursive;
      color:#ff6fa5;
      margin-bottom:20px;
      text-shadow:1px 1px #ffc1d6;
    }
    input, button {
      margin:8px 0;
      padding:12px;
      border-radius:12px;
      border:1px solid #ddd;
      font-size:14px;
    }
    input {
      width:100%;
      outline:none;
    }
    .row {
      display:flex;
      gap:10px;
      margin-bottom:8px;
    }
    .row input { flex:1; }

    button {
      background:#ff6fa5;
      color:white;
      border:none;
      font-weight:bold;
      cursor:pointer;
      transition:0.3s;
      padding:12px;
      position:relative;
      border-radius:10px;
    }
    button:hover { background:#ff4f8c; transform:translateY(-2px); }
    .add-btn { background:#ffb347; }
    .add-btn:hover { background:#ff9933; }

    /* Spinner */
    .loading { pointer-events: none; opacity: 0.7; }
    .loading::after {
      content: "";
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      border: 2px solid white;
      border-top: 2px solid transparent;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      from { transform: translateY(-50%) rotate(0deg); }
      to { transform: translateY(-50%) rotate(360deg); }
    }

    #productList div {
      margin:10px 0;
      padding:10px;
      background:#fff;
      border-radius:10px;
      box-shadow:0 2px 5px rgba(0,0,0,0.1);
      text-align:left;
    }
    #productList button {
      margin-top:5px;
      margin-right:5px;
      padding:8px 12px;
      border-radius:8px;
      font-size:13px;
    }
    .delete-btn { background:#ff4f4f; }
    .delete-btn:hover { background:#cc0000; }
  </style>
</head>
<body>
  <div class="card">
    <h2>üç©Control Panelüç©</h2>
    <form id="loginForm">
      <input type="text" id="user" placeholder="Username" required><br>
      <input type="password" id="pass" placeholder="Password" required><br>
      <button type="submit" id="loginBtn">Login</button>
    </form>

    <div id="adminPanel" style="display:none;">
      <h2 id="formTitle">INPUT PRODUK</h2>
      <form id="productForm">
        <input type="hidden" id="row"> <!-- dipakai saat edit -->
        <input type="text" id="nama" placeholder="Nama Produk" required><br>
        <input type="number" id="harga" placeholder="Harga Produk" required><br>

        <div id="toppingContainer">
          <div class="row topping-group">
            <input type="text" class="topping-name" placeholder="Nama Topping">
            <input type="number" class="topping-price" placeholder="Harga">
          </div>
        </div>
        <button type="button" class="add-btn" onclick="addTopping()">+ Tambah Topping</button><br>

        <input type="file" id="foto" accept="image/*"><br>
        <button type="submit" id="saveBtn">Simpan Produk</button>
      </form>

      <h2>Daftar Produk</h2>
      <div id="productList"></div>
    </div>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbz8OQ2w68DXtXbYudR8nxV9KcruIl5iNQHFHG4ISOjg3S8W1X9ps8mw8U9H7hwqzIIN/exec"; // ganti pake URL GAS

    let editMode = false; // apakah form sedang edit

    // LOGIN
    document.getElementById("loginForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      let btn = document.getElementById("loginBtn");
      btn.classList.add("loading");
      btn.innerText = "Login...";
      let user = document.getElementById("user").value;
      let pass = document.getElementById("pass").value;

      let res = await fetch(GAS_URL+"?action=login&user="+user+"&pass="+pass);
      let data = await res.json();

      btn.classList.remove("loading");
      btn.innerText = "Login";

      if(data.success){
        document.getElementById("loginForm").style.display="none";
        document.getElementById("adminPanel").style.display="block";
        loadProducts();
      } else {
        alert("Login gagal!");
      }
    });

    // Tambah field topping
    function addTopping(){
      const toppingContainer = document.getElementById("toppingContainer");
      let div = document.createElement("div");
      div.className = "row topping-group";
      div.innerHTML = `
        <input type="text" class="topping-name" placeholder="Nama Topping">
        <input type="number" class="topping-price" placeholder="Harga">
      `;
      toppingContainer.appendChild(div);
    }

    // Konversi file ‚Üí Base64
    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(",")[1]);
        reader.onerror = error => reject(error);
      });
    }

    // FORM TAMBAH / UPDATE PRODUK
    document.getElementById("productForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      let btn = document.getElementById("saveBtn");
      btn.classList.add("loading");
      btn.innerText = editMode ? "Mengupdate..." : "Menyimpan...";

      let nama = document.getElementById("nama").value;
      let harga = document.getElementById("harga").value;
      let row = document.getElementById("row").value;

      // Gabung semua topping
      let toppingEls = document.querySelectorAll(".topping-group");
      let topings = [];
      toppingEls.forEach(el => {
        let name = el.querySelector(".topping-name").value.trim();
        let price = el.querySelector(".topping-price").value.trim();
        if(name !== "" && price !== ""){
          topings.push({nama:name, harga:price});
        }
      });

      let fotoFile = document.getElementById("foto").files[0];
      let fotoBase64 = fotoFile ? await toBase64(fotoFile) : "";

      let formData = new URLSearchParams();
      formData.append("action", editMode ? "edit" : "add");
      formData.append("nama", nama);
      formData.append("harga", harga);
      formData.append("topings", JSON.stringify(topings));
      if(editMode) formData.append("row", row);
      if(fotoBase64) formData.append("foto", fotoBase64);

      let res = await fetch(GAS_URL, { method: "POST", body: formData });
      let data = await res.json();

      btn.classList.remove("loading");
      btn.innerText = editMode ? "Update Produk" : "Simpan Produk";

      if(data.success){
        alert(editMode ? "Produk berhasil diupdate!" : "Produk berhasil ditambahkan!");
        resetForm();
        loadProducts();
      } else {
        alert("Gagal simpan produk");
      }
    });

    // Reset form kembali ke mode tambah
    function resetForm(){
      document.getElementById("productForm").reset();
      document.getElementById("toppingContainer").innerHTML = `
        <div class="row topping-group">
          <input type="text" class="topping-name" placeholder="Nama Topping">
          <input type="number" class="topping-price" placeholder="Harga">
        </div>`;
      editMode = false;
      document.getElementById("formTitle").innerText = "INPUT PRODUK";
      document.getElementById("saveBtn").innerText = "Simpan Produk";
      document.getElementById("row").value = "";
    }

    // Load daftar produk
    async function loadProducts(){
      let res = await fetch(GAS_URL+"?action=getMenu");
      let data = await res.json();
      let list = document.getElementById("productList");
      list.innerHTML = "";
      data.forEach((item)=>{
        let div = document.createElement("div");
        div.innerHTML = `
          <strong>${item.Nama}</strong> - Rp${item.Harga}<br>
          <small>Topping: ${item.Topping||"-"}</small><br>
          <button onclick="editProduct(${item.Row}, '${item.Nama}', '${item.Harga}', '${item.Topping||""}', '${item.FotoURL}')">‚úèÔ∏è Edit</button>
          <button onclick="deleteProduct(${item.Row})" class="delete-btn">üóë Hapus</button>
        `;
        list.appendChild(div);
      });
    }

    // Fungsi hapus produk
    async function deleteProduct(row){
      if(!confirm("Yakin mau hapus produk ini?")) return;
      let formData = new URLSearchParams();
      formData.append("action", "delete");
      formData.append("row", row);

      let res = await fetch(GAS_URL, { method:"POST", body: formData });
      let data = await res.json();

      if(data.success){
        alert("Produk berhasil dihapus!");
        loadProducts();
      } else {
        alert("Gagal hapus produk!");
      }
    }

    // Fungsi edit produk
    function editProduct(row, nama, harga, topping, foto){
      editMode = true;
      document.getElementById("formTitle").innerText = "EDIT PRODUK";
      document.getElementById("saveBtn").innerText = "Update Produk";
      document.getElementById("row").value = row;
      document.getElementById("nama").value = nama;
      document.getElementById("harga").value = harga;

      // isi topping
      document.getElementById("toppingContainer").innerHTML = "";
      if(topping && topping !== ""){
        topping.split(",").forEach(t => {
          let [namaT, hargaT] = t.split(":");
          let div = document.createElement("div");
          div.className = "row topping-group";
          div.innerHTML = `
            <input type="text" class="topping-name" value="${namaT.trim()}" placeholder="Nama Topping">
            <input type="number" class="topping-price" value="${hargaT?hargaT.trim():""}" placeholder="Harga">
          `;
          document.getElementById("toppingContainer").appendChild(div);
        });
      } else {
        addTopping();
      }
    }
  </script>
  </div> <!-- penutup .card -->

  <footer style="position:fixed; bottom:0; left:0; width:100%; text-align:center; padding:10px; background:#ffe4ec; color:#ff4f8c; font-size:14px; font-weight:600; border-top:2px solid #ffb6c1;">
    üç© Vivi Snacks Admin Panel | Made with ‚ù§Ô∏è 
  </footer>
</body>
</html>

